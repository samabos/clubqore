name: Deploy ClubQore to VPS

on:
  pull_request:
    branches:
      - main # Deploy staging on PR to main branch
  push:
    branches:
      - main # Deploy production on push to main branch

env:
  DOCKER_REGISTRY: docker.io
  BACKEND_IMAGE_NAME: clubqore-backend
  FRONTEND_IMAGE_NAME: clubqore-frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Use GitHub Environments for environment-specific secrets
    environment:
      name: ${{ github.event_name == 'push' && 'production' || 'staging' }}
      url: ${{ github.event_name == 'push' && 'https://app.clubqore.com' || 'https://staging.clubqore.com' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "DEPLOY_PATH=/root/clubqore" >> $GITHUB_ENV
            echo "COMPOSE_FILE=docker-compose.prod.yml" >> $GITHUB_ENV
            echo "FRONTEND_API_URL=https://api.clubqore.com" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "DEPLOY_PATH=/root/clubqore-staging" >> $GITHUB_ENV
            echo "COMPOSE_FILE=docker-compose.staging.yml" >> $GITHUB_ENV
            echo "FRONTEND_API_URL=https://www.clubqore.com/api" >> $GITHUB_ENV
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push backend to DockerHub
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.run_number }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:buildcache,mode=max

      - name: Build and push frontend to DockerHub
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: linux/amd64
          push: true
          build-args: |
            VITE_API_URL=${{ env.FRONTEND_API_URL }}
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.run_number }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:buildcache,mode=max

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory on VPS
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}/letsencrypt"

      - name: Sync docker-compose files to VPS
        run: |
          rsync -avz --delete \
            --include='docker-compose.prod.yml' \
            --include='docker-compose.staging.yml' \
            --include='letsencrypt/' \
            --exclude='*' \
            ./ ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Create .env file on VPS
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "cat > ${{ env.DEPLOY_PATH }}/.env << 'EOF'
          # Docker configuration
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          GITHUB_RUN_NUMBER=${{ github.run_number }}

          # Database configuration (environment-specific)
          STAGING_POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          STAGING_POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          STAGING_POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

          # JWT secrets
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}

          # Frontend URL (environment-specific)
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}

          # Email configuration
          EMAIL_PROVIDER=${{ secrets.EMAIL_PROVIDER }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EMAIL_FROM_NAME=${{ secrets.EMAIL_FROM_NAME }}
          EMAIL_FROM_EMAIL=${{ secrets.EMAIL_FROM_EMAIL }}

          # SSL/ACME configuration
          ACME_EMAIL=${{ secrets.ACME_EMAIL }}
          EOF"

      - name: Deploy on VPS
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "üöÄ Deploying ClubQore (${{ env.ENVIRONMENT }})..."

            # Debug: Show environment variables
            echo "üîç Debug: Environment variables:"
            echo "STAGING_POSTGRES_DB: ${STAGING_POSTGRES_DB}"
            echo "STAGING_POSTGRES_USER: ${STAGING_POSTGRES_USER}"
            echo "JWT_SECRET: $([ -n "${JWT_SECRET}" ] && echo "Set" || echo "Missing")"

            # Pull latest images
            echo "üì¶ Pulling Docker images..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.run_number }}
            docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.run_number }}

            # Stop existing containers
            echo "üõë Stopping existing containers..."
            docker compose -f ${{ env.COMPOSE_FILE }} down || true

            # Start new containers
            echo "‚ñ∂Ô∏è  Starting new containers..."
            docker compose -f ${{ env.COMPOSE_FILE }} up -d

            # Wait for services to be healthy
            echo "‚è≥ Waiting for services to start..."
            sleep 10

            # Check service status
            echo "‚úÖ Service status:"
            docker compose -f ${{ env.COMPOSE_FILE }} ps

            # Clean up old images
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -af --filter "until=168h" || true

            echo "‚ú® Deployment complete!"
          ENDSSH

      - name: Verify deployment
        run: |
          if [ "${{ env.ENVIRONMENT }}" == "production" ]; then
            BACKEND_URL="https://api.clubqore.com"
            FRONTEND_URL="https://app.clubqore.com"
          else
            BACKEND_URL="https://www.clubqore.com/api"
            FRONTEND_URL="https://www.clubqore.com"
          fi

          echo "üîç Verifying deployment..."

          # Wait a bit for SSL to be ready
          sleep 15

          # Check backend health (if health endpoint exists)
          if curl -f -s "$BACKEND_URL/health" > /dev/null 2>&1; then
            echo "‚úÖ Backend is healthy"
          else
            echo "‚ö†Ô∏è  Backend health check failed (endpoint may not exist yet)"
          fi

          # Check frontend
          if curl -f -s "$FRONTEND_URL" > /dev/null 2>&1; then
            echo "‚úÖ Frontend is accessible"
          else
            echo "‚ö†Ô∏è  Frontend check failed"
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful to ${{ env.ENVIRONMENT }}!"
            echo "Backend: https://api$([ '${{ env.ENVIRONMENT }}' == 'staging' ] && echo '-staging' || echo '').clubqore.com"
            echo "Frontend: https://$([ '${{ env.ENVIRONMENT }}' == 'staging' ] && echo 'staging' || echo 'app').clubqore.com"
          else
            echo "‚ùå Deployment to ${{ env.ENVIRONMENT }} failed!"
          fi
